- name: create inventry file
  local_action: shell python {{ inventory_dir }}/{{ inventory_file }} > hosts.json

- name: convert inventry from json to yaml
  local_action: shell ruby -ryaml -rjson -e 'puts YAML.dump(JSON.parse(STDIN.read))' < hosts.json > hosts.yml

- name: get ansible real username
  local_action: shell tower-cli credential get `tower-cli job_template get {{ awx_job_template_id }} -f json | jq .credential` -f json | jq .inputs.username -r
  register: ansible_real_user

- name: serverspec
  environment:
    ansible_user: '{{ ansible_real_user.stdout }}'
    ansible_password: '{{ ansible_password }}'
    ansible_port: '{{ ansible_port }}'
    ansible_connection: '{{ ansible_connection }}'
    ansible_winrm_server_cert_validation: '{{ ansible_winrm_server_cert_validation }}'
  local_action: shell rake spec:{{ group_names[0] }}:{{ inventory_hostname }}
